<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Barcode Scanner</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1a73e8">

  <style>
    body { margin:0; background:#fff; font-family:system-ui; }
    .app { height:100vh; display:flex; flex-direction:column; }

    .barcode-area{
      height:2in;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
    }

    #preview-container {
      position: relative; /* Container for video and the scanning frame/mask */
      width: 100%;
      flex: 1; /* Video will take available space */
      display: none; /* Hide by default */
    }

    #preview {
      width: 100%;
      height: 100%;
      object-fit: cover; /* Ensure video covers the container */
      background: #000;
      display: block;
    }

    /* --- Scanning Mask/Viewport (Focus Area) --- */
    .scan-mask {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none; /* Allows clicks/taps to pass through to the video */
    }

    .scan-mask-box {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 80%; /* Adjust as needed */
      height: 20%; /* Adjust as needed */
      transform: translate(-50%, -50%);
      border: 2px solid #ff0000; /* Red border to indicate scan area */
      box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5); /* Darkens the area outside the box */
      box-sizing: border-box;
      border-radius: 4px;
    }
    /* ------------------------------------------- */

    .input-area{
      background:#fff;
      padding:10px;
      display:flex;
      gap:8px;
    }

    input { flex:1; padding:12px; border-radius:8px; font-size:18px; border:1px solid #ccc; }
    button { padding:10px 14px; border-radius:8px; border:none; background:#1a73e8; color:#fff; cursor:pointer; }
  </style>
</head>
<body>

<div class="app">

  <div class="barcode-area">
    <svg id="barcode"></svg>
    <div id="barcodeLabel">—</div>
  </div>

  <div id="preview-container">
    <video id="preview" playsinline></video>
    <div class="scan-mask">
      <div class="scan-mask-box"></div>
    </div>
  </div>

  <div class="input-area">
    <button id="scanBtn">Scan Barcode</button>
    <input id="textInput" placeholder="Type or Scan…" />
    <button id="clearBtn">Clear</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>

<script>
  const input = document.getElementById("textInput");
  const barcode = document.getElementById("barcode");
  const label = document.getElementById("barcodeLabel");
  const scanBtn = document.getElementById("scanBtn");
  const clearBtn = document.getElementById("clearBtn");
  const video = document.getElementById("preview");
  const videoContainer = document.getElementById("preview-container");

  // Function to clean up scanned text (only keep letters and spaces)
  function cleanupScannedText(text) {
    if (!text) return "";
    // Regex to remove all numbers and trim leading/trailing spaces.
    // This addresses your need to get "just name" even if there are numbers.
    return text.replace(/[0-9]/g, '').trim(); 
  }

  function render(val){
    if(!val){ barcode.innerHTML=""; label.textContent="—"; return; }
    JsBarcode(barcode, val, {format:"CODE128", displayValue:false});
    // Display the cleaned-up version of the scanned text in the label
    label.textContent = cleanupScannedText(val); 
  }

  input.addEventListener("input",()=> render(input.value));
  clearBtn.addEventListener("click",()=>{ 
    input.value=""; 
    render(""); 
  });
  
  // Instance of the Code Reader
  let codeReader;
  let currentStream;

  scanBtn.addEventListener("click", async ()=> {
    if(!codeReader) {
      // Use BrowserQRCodeReader or BrowserCodeReader for a simpler setup if MultiFormat is causing issues
      // But BrowserMultiFormatReader is generally better for different code types.
      codeReader = new ZXing.BrowserMultiFormatReader();
    }

    try{
      // Show the video container
      videoContainer.style.display = "block";

      // Request camera stream
      currentStream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"environment"} });
      video.srcObject = currentStream;
      video.play();
      
      // Stop previous scanning if any and start decoding
      codeReader.reset();

      codeReader.decodeFromVideoDevice(null, video, (result, err)=>{
        if(result){
          const rawText = result.text;
          const cleanedText = cleanupScannedText(rawText);

          // Update input with the original scanned text (for full data capture)
          input.value = rawText; 
          
          // Render barcode and update label with the cleaned-up name
          render(rawText); 

          // Stop video stream and hide container after successful scan
          if (currentStream) {
            currentStream.getTracks().forEach(t => t.stop());
            currentStream = null;
          }
          codeReader.reset();
          videoContainer.style.display = "none";
        }
        
        // Handle error (e.g., failed to decode)
        if (err && !(err instanceof ZXing.NotFoundException)) {
            // console.error(err); // For debugging
        }
      });

    }catch(err){
      alert("Camera permission needed.\nPlease allow camera in browser settings: " + err);
      // Ensure UI is reset if camera access fails
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
      if (codeReader) codeReader.reset();
      videoContainer.style.display = "none";
    }
  });

  // Initial render for empty state
  render(input.value);

  // Register service worker (Assuming sw.js exists for PWA features)
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("sw.js").catch(e => console.error("SW failed", e));
  }
</script>

</body>
</html>
