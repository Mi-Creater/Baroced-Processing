<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCR Barcode Generator</title>

  <style>
    body { margin:0; font-family:system-ui; background:#fff; }
    #preview { width:100%; display:none; background:#000; }
    .input-area { position:fixed; bottom:0; left:0; right:0; padding:10px; background:#fff; display:flex; gap:8px; }
    input { flex:1; padding:12px; font-size:18px; border-radius:8px; }
    button { padding:10px 14px; border-radius:8px; border:none; background:#1a73e8; color:#fff; }
    .barcode-area { height:160px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
  </style>
</head>
<body>

<video id="preview" playsinline></video>

<div class="barcode-area">
  <svg id="barcode"></svg>
  <div id="barcodeLabel">—</div>
</div>

<div style="height:240px"></div>

<div class="input-area">
  <button id="scanBtn">Scan</button>
  <input id="textInput" placeholder="Type or Scan…" />
  <button id="clearBtn">Clear</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<!-- OCR library -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<script>
  const video = document.getElementById("preview");
  const input = document.getElementById("textInput");
  const scanBtn = document.getElementById("scanBtn");
  const clearBtn = document.getElementById("clearBtn");
  const barcode = document.getElementById("barcode");
  const label = document.getElementById("barcodeLabel");

  function render(txt){
    if(!txt){ barcode.innerHTML=""; label.textContent="—"; return; }
    JsBarcode(barcode, txt, {format:"CODE128", displayValue:false});
    label.textContent = txt;
  }

  input.addEventListener("input", ()=> render(input.value));
  clearBtn.addEventListener("click", ()=>{ input.value=""; render(""); });

  scanBtn.addEventListener("click", async ()=>{
    try{
      video.style.display = "block";

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
      });

      video.srcObject = stream;
      await video.play();

      // Wait 500ms camera stable
      await new Promise(r => setTimeout(r, 500));

      // Capture frame
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);

      // STOP CAMERA
      stream.getTracks().forEach(t => t.stop());
      video.style.display = "none";

      // OCR (Extract text only)
      const result = await Tesseract.recognize(canvas, "eng", {
        tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 -"
      });

      let text = result.data.text.trim();

      // Clean text: remove extra lines
      text = text.split("\n")
                 .map(t => t.trim())
                 .filter(t => t.length > 0)
                 .join(" ");

      input.value = text;
      render(text);

    }catch(err){
      alert("Camera permission required! Enable in browser settings.");
    }
  });
</script>

</body>
</html>
